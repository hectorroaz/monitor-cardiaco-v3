<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor de Frecuencia Cardíaca BLE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    button { transition: background-color 0.3s ease, transform 0.1s ease; }
    button:active { transform: scale(0.98); }
    select { color: #fff; background: #23272f; border: 1px solid #444; border-radius: 8px; padding: 0.5em 1.2em; font-size: 1rem; }
    select:focus { outline: 2px solid #a3e635; }
    @keyframes pulsate {
      0% { transform: scale(1);}
      50% { transform: scale(1.15);}
      100% { transform: scale(1);}
    }
    .heartbeat-animation {
      animation-name: pulsate;
      animation-duration: 1s;
      animation-iteration-count: infinite;
      animation-timing-function: ease-in-out;
    }
    #fullscreenContainer { background: #000 !important; padding:0!important; margin:0!important; }
    .timer-box {
      font-family: 'Inter', monospace;
      font-size: 2.7rem;
      font-weight: 700;
      color: #06b6d4;
      margin-bottom: 1.2em;
      letter-spacing: 0.04em;
    }
    .controls-row {
      display: flex;
      flex-direction: row;
      gap: 1.4rem;
      justify-content: center;
      align-items: center;
    }
    .circle-btn {
      width: 3.3rem;
      height: 3.3rem;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      outline: none;
      cursor: pointer;
    }
    .circle-btn svg { width: 2rem; height: 2rem; }
    .btn-play { background: #16a34a; }
    .btn-pause { background: #dc2626; }
    .btn-reset { background: #6b7280; }
    .btn-play:hover { background: #15803d; }
    .btn-pause:hover { background: #991b1b; }
    .btn-reset:hover { background: #334155; }
    .fullscreen-flex-vertical {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0;
    }
    .hr-container {
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .controls-container {
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .hr-size-proto {
      opacity: 0;
      position: absolute;
      left: 0; top: 0; pointer-events: none;
      user-select: none;
      z-index: 0;
    }
    #fullscreenHeartRateVisible {
      font-weight: 800;
      font-size: inherit;
      line-height: 1;
      text-align: center;
      word-break: break-all;
      white-space: nowrap;
      letter-spacing: -0.02em;
      margin: 0;
      padding: 0;
      overflow: hidden;
      display: block;
      z-index: 1;
      user-select: none;
      transition: color 0.2s;
    }
    .hr-blue { color: #3b82f6 !important; }
    .hr-green { color: #22d3ee !important; }
    .hr-yellow { color: #fde047 !important; }
    .hr-orange { color: #fb923c !important; }
    .hr-red { color: #ef4444 !important; }
    .indicador-flecha {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 2vw;
      font-size: 3rem;
      font-weight: 700;
      transition: color 0.18s;
      color: #f59e42;
      text-shadow: 0 2px 9px #0007;
      opacity: 1;
      min-width: 2.7rem;
      height: 2.7rem;
      user-select: none;
    }
    .indicador-flecha.arriba { color: #f87171; } /* Rojo suave */
    .indicador-flecha.abajo { color: #60a5fa; }  /* Azul claro */
    .indicador-flecha.ok { opacity: 0; }         /* Invisible si ok */
    @media (orientation: landscape) {
      .fullscreen-flex-vertical {
        flex-direction: row;
        align-items: stretch;
        gap: 0;
      }
      .controls-container {
        width: 45vw; max-width: 450px; min-width: 260px;
        height: 100vh;
        justify-content: center;
        align-items: flex-end;
        padding-right: 2vw;
      }
      .hr-container {
        width: 55vw; min-width: 340px;
        height: 100vh;
        justify-content: flex-start;
        align-items: center;
      }
    }
    .zone-goal-txt {
      display: block;
      margin-top: 2vh;
      margin-bottom: 0;
      font-size: 1.2rem;
      color: #a3e635;
      letter-spacing: 0.03em;
      text-align: center;
      font-weight: 500;
      opacity: .96;
      text-shadow: 0 2px 12px #0009;
    }
    .result-msg {
      background: #18181b;
      color: #fafafa;
      border-radius: 1.2rem;
      padding: 1.1em 1.5em;
      font-size: 1.25rem;
      font-weight: 500;
      margin: 0.9em auto 0 auto;
      max-width: 95vw;
      box-shadow: 0 2px 16px #0006;
      border: 1.7px solid #444;
      text-align: center;
    }
    .descPlan {
      color: #e0e0e0;
      font-size: 0.97rem;
      padding: 0.35em 0.6em 0.2em 0.6em;
      text-align: center;
      margin-bottom: 0.1em;
      min-height: 2.6em;
    }
  </style>
</head>
<body class="bg-black text-white flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-md bg-black rounded-2xl shadow-lg p-8 space-y-6 text-center">
    <header>
      <h1 class="text-3xl font-bold text-white">Monitor de Ritmo Cardíaco</h1>
      <div class="text-gray-400 mt-1 mb-4 text-sm">v 3.3.2</div>
      <div class="flex flex-col items-center mb-2">
        <select id="planSelector"></select>
        <span id="planDesc" class="descPlan"></span>
      </div>
      <p class="text-gray-400 mt-2">Conéctate a tu banda de frecuencia cardíaca BLE.</p>
    </header>
    <div class="border border-gray-700 rounded-lg p-6 bg-gray-900">
      <div class="flex justify-center items-center mb-4">
        <svg id="heartIcon" class="w-16 h-16 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
      </div>
      <div id="heartRateDisplay" class="text-7xl font-bold text-white tracking-tight">--</div>
      <div class="text-lg text-gray-400">BPM</div>
      <p id="bluetoothStatus" class="mt-4 text-sm text-gray-400 h-5">Estado: Desconectado</p>
    </div>
    <div>
      <button id="connectBluetooth" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
        Conectar a Sensor
      </button>
    </div>
    <div>
      <button id="fullscreenBtn" class="w-full mt-3 bg-white text-black font-semibold py-3 px-6 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white">
        Pantalla Completa
      </button>
    </div>
    <div id="resultMsg" class="result-msg" style="display:none;"></div>
  </div>

  <!-- Pantalla Completa -->
  <div id="fullscreenContainer" class="hidden fixed inset-0 bg-black z-50">
    <div class="fullscreen-flex-vertical w-full h-full">
      <!-- Controles y contador -->
      <div class="controls-container">
        <span class="timer-box" id="sessionTime">00:00:00</span>
        <div class="controls-row mt-2 mb-8">
          <button id="sessionPlayBtn" class="circle-btn btn-play" title="Iniciar">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#16a34a"/><polygon points="10,8 16,12 10,16" fill="#fff"/></svg>
          </button>
          <button id="sessionPauseBtn" class="circle-btn btn-pause" title="Pausar">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#dc2626"/><rect x="9" y="8" width="2" height="8" rx="1" fill="#fff"/><rect x="13" y="8" width="2" height="8" rx="1" fill="#fff"/></svg>
          </button>
          <button id="resetSessionBtn" class="circle-btn btn-reset" title="Reiniciar">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#6b7280"/><path d="M12 8v4l3 3" stroke="#fff" stroke-width="2" fill="none"/><circle cx="12" cy="12" r="6" stroke="#fff" stroke-width="2" fill="none"/></svg>
          </button>
        </div>
        <button id="exitFullscreenBtn" class="mt-8 bg-gray-800 text-white px-10 py-5 rounded-xl text-2xl hover:bg-gray-900">Salir</button>
      </div>
      <!-- HR gigante fijo -->
      <div class="hr-container">
        <span id="fullscreenHeartRateProto" class="hr-size-proto">188</span>
        <span id="fullscreenHeartRateVisible">--</span>
        <span id="indicadorFlecha" class="indicador-flecha"></span>
      </div>
    </div>
    <span id="zoneGoalTxt" class="zone-goal-txt"></span>
  </div>

  <script>
    // --- Planes sugeridos para seleccionar ---
    const planes = [
      {
        nombre: "Caminata ligera o descanso (Z1–Z2)",
        objetivo: "Estrés mínimo, regeneración",
        min: 100, max: 120,
        txt: "Zona objetivo: 100–120 bpm (Recuperación)",
        desc: "Ideal para recuperación, regeneración, fatiga acumulada, día suave."
      },
      {
        nombre: "Intervalos largos / clásicos (Z2–Z4)",
        objetivo: "Alta quema calórica, EPOC",
        min: 130, max: 165,
        txt: "Zona objetivo: 130–165 bpm (Intervalos/EPOC)",
        desc: "Para sesiones de alta intensidad, picos, gasto calórico alto, efecto postcombustión (EPOC)."
      },
      {
        nombre: "Base aeróbica continua (Z2)",
        objetivo: "Máxima oxidación de grasa",
        min: 115, max: 135,
        txt: "Zona objetivo: 115–135 bpm (Aeróbico base)",
        desc: "Sesión de intensidad media, estable y prolongada. Máxima quema de grasa, mínimo desgaste."
      },
      {
        nombre: "Intervalos cortos y suaves (Z2–Z3)",
        objetivo: "Cardio variado sin fatiga",
        min: 115, max: 150,
        txt: "Zona objetivo: 115–150 bpm (Intervalos suaves)",
        desc: "Intervalos con cambios suaves, mejora agilidad metabólica y variabilidad sin fatiga."
      }
    ];

    // Lógica de selección
    const planSelector = document.getElementById('planSelector');
    const planDesc = document.getElementById('planDesc');
    const zoneGoalTxt = document.getElementById('zoneGoalTxt');
    let planActualIdx = 0;
    function updatePlanUI(idx) {
      planActualIdx = idx;
      zoneGoalTxt.textContent = planes[idx].txt;
      planDesc.textContent = planes[idx].desc;
      updateFullScreenHeartRate(lastHR ?? '--');
    }
    // Rellenar el selector
    function renderPlanSelector() {
      planSelector.innerHTML = "";
      planes.forEach((p, i) => {
        const op = document.createElement('option');
        op.value = i;
        op.textContent = p.nombre + " — " + p.objetivo;
        planSelector.appendChild(op);
      });
      // Selección por defecto según día
      let def = 0;
      const today = new Date().getDay();
      if ([1,5].includes(today)) def = 1;
      else if ([2,4,6].includes(today)) def = 2;
      else if (today === 3) def = 3;
      else def = 0;
      planSelector.value = def;
      updatePlanUI(def);
    }
    planSelector.addEventListener('change', (e) => {
      updatePlanUI(Number(e.target.value));
    });

    // --- Wake Lock ---
    let wakeLock = null;
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {});
        }
      } catch (err) {}
    }
    document.addEventListener('visibilitychange', () => {
      if (wakeLock !== null && document.visibilityState === 'visible') {
        requestWakeLock();
      }
    });

    // UI Elements
    const connectBluetoothBtn = document.getElementById('connectBluetooth');
    const bluetoothStatusElem = document.getElementById('bluetoothStatus');
    const heartRateDisplayElem = document.getElementById('heartRateDisplay');
    const heartIconElem = document.getElementById('heartIcon');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const fullscreenContainer = document.getElementById('fullscreenContainer');
    const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');
    const resultMsg = document.getElementById('resultMsg');
    // Cronómetro
    const sessionTime = document.getElementById('sessionTime');
    const sessionPlayBtn = document.getElementById('sessionPlayBtn');
    const sessionPauseBtn = document.getElementById('sessionPauseBtn');
    const resetSessionBtn = document.getElementById('resetSessionBtn');
    // HR Visual
    const fullscreenHeartRateProto = document.getElementById('fullscreenHeartRateProto');
    const fullscreenHeartRateVisible = document.getElementById('fullscreenHeartRateVisible');
    const indicadorFlecha = document.getElementById('indicadorFlecha');

    // ---- Inicialización selector de planes ----
    renderPlanSelector();

    // ---- Cronómetro ----
    let sessionInterval = null;
    let sessionStart = null;
    let sessionElapsed = 0;
    let sessionRunning = false;
    let secondsInZone = 0;

    function formatDuration(ms) {
      const total = Math.floor(ms / 1000);
      const h = Math.floor(total / 3600);
      const m = Math.floor((total % 3600) / 60);
      const s = total % 60;
      return [
        h.toString().padStart(2, '0'),
        m.toString().padStart(2, '0'),
        s.toString().padStart(2, '0')
      ].join(':');
    }
    function startSession() {
      if (!sessionRunning) {
        sessionRunning = true;
        sessionStart = Date.now() - sessionElapsed;
        sessionInterval = setInterval(updateSessionTime, 1000);
      }
    }
    function pauseSession() {
      if (sessionRunning) {
        sessionRunning = false;
        sessionElapsed = Date.now() - sessionStart;
        clearInterval(sessionInterval);
      }
    }
    function resetSession() {
      sessionRunning = false;
      sessionElapsed = 0;
      secondsInZone = 0;
      clearInterval(sessionInterval);
      sessionTime.textContent = "00:00:00";
    }
    function updateSessionTime() {
      if (sessionRunning) {
        sessionElapsed = Date.now() - sessionStart;
        sessionTime.textContent = formatDuration(sessionElapsed);
        // Sumar segundo si el HR está en zona objetivo
        if (lastHR && isInZone(lastHR)) {
          secondsInZone++;
        }
      } else {
        sessionTime.textContent = formatDuration(sessionElapsed);
      }
    }
    sessionPlayBtn.addEventListener('click', startSession);
    sessionPauseBtn.addEventListener('click', pauseSession);
    resetSessionBtn.addEventListener('click', resetSession);

    // ---- BLE + BPM logic ----
    let heartRateCharacteristic = null;
    let bleDevice = null;
    let lastHR = null;

    connectBluetoothBtn.addEventListener('click', async () => {
      if (!navigator.bluetooth) {
        bluetoothStatusElem.textContent = 'Error: Web Bluetooth no es compatible.';
        bluetoothStatusElem.classList.add('text-red-600');
        return;
      }
      try {
        bluetoothStatusElem.textContent = 'Buscando sensor...';
        connectBluetoothBtn.disabled = true;
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['heart_rate'] }],
          optionalServices: ['device_information']
        });
        bluetoothStatusElem.textContent = `Conectando a ${bleDevice.name || 'dispositivo'}...`;
        bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
        const server = await bleDevice.gatt.connect();
        bluetoothStatusElem.textContent = 'Obteniendo servicio...';
        const service = await server.getPrimaryService('heart_rate');
        heartRateCharacteristic = await service.getCharacteristic('heart_rate_measurement');
        await heartRateCharacteristic.startNotifications();
        bluetoothStatusElem.textContent = '¡Conectado! Escuchando latidos...';
        bluetoothStatusElem.classList.add('text-green-600');
        requestWakeLock();
        heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateNotification);
      } catch (error) {
        bluetoothStatusElem.textContent = `Error: ${error.message}`;
        bluetoothStatusElem.classList.add('text-red-600');
        connectBluetoothBtn.disabled = false;
      }
    });

    function handleHeartRateNotification(event) {
      const value = event.target.value;
      const heartRate = parseHeartRate(value);
      heartRateDisplayElem.textContent = heartRate;
      updateFullScreenHeartRate(heartRate);
      lastHR = heartRate;
      if (heartRate > 0) {
        const animationDuration = 60 / heartRate;
        heartIconElem.style.animationDuration = `${animationDuration.toFixed(2)}s`;
        heartIconElem.classList.add('heartbeat-animation');
      } else {
        heartIconElem.classList.remove('heartbeat-animation');
      }
    }

    function parseHeartRate(value) {
      const flags = value.getUint8(0);
      const rate16Bits = (flags & 0x1) !== 0;
      if (rate16Bits) {
        return value.getUint16(1, true);
      } else {
        return value.getUint8(1);
      }
    }

    function onDisconnected() {
      bluetoothStatusElem.textContent = 'Dispositivo desconectado.';
      bluetoothStatusElem.classList.remove('text-green-600');
      bluetoothStatusElem.classList.add('text-red-600');
      heartRateDisplayElem.textContent = '--';
      if (heartRateCharacteristic) {
        heartRateCharacteristic.removeEventListener('characteristicvaluechanged', handleHeartRateNotification);
        heartRateCharacteristic = null;
      }
      updateFullScreenHeartRate('--');
      lastHR = null;
    }

    // --- Zona objetivo lógica ---
    function isInZone(hr) {
      if (isNaN(hr)) return false;
      hr = Number(hr);
      const {min, max} = planes[planActualIdx];
      return hr >= min && hr <= max;
    }

    // Flecha lógica: retorna "arriba", "abajo" o "ok"
    function getIndicadorFlecha(hr) {
      if (isNaN(hr) || hr === '--') return 'ok';
      hr = Number(hr);
      const {min, max} = planes[planActualIdx];
      if (hr < min - 2) return "arriba";
      if (hr > max + 2) return "abajo";
      return "ok";
    }

    // Colores por zonas clásicas (visuales)
    function getZoneClass(hr) {
      if (isNaN(hr) || hr === '--') return '';
      hr = Number(hr);
      if (hr >= 94 && hr < 113) return 'hr-blue';
      if (hr >= 113 && hr < 132) return 'hr-green';
      if (hr >= 132 && hr < 150) return 'hr-yellow';
      if (hr >= 150 && hr < 170) return 'hr-orange';
      if (hr >= 170) return 'hr-red';
      return '';
    }

    // Ajusta fuente gigante y actualiza flecha
    function fitHeartRateFontSize() {
      const proto = fullscreenHeartRateProto;
      if (!proto) return;
      let boxW, boxH;
      if (window.matchMedia("(orientation: landscape)").matches) {
        boxW = window.innerWidth * 0.53;
        boxH = window.innerHeight * 0.93;
      } else {
        boxW = window.innerWidth * 0.95;
        boxH = window.innerHeight * 0.33;
      }
      proto.textContent = '188';
      proto.style.fontSize = '200px';
      const rect = proto.getBoundingClientRect();
      const scaleW = boxW / rect.width;
      const scaleH = boxH / rect.height;
      const scale = Math.min(scaleW, scaleH, 1.17);
      const newFontSize = 200 * scale;
      proto.style.fontSize = newFontSize + 'px';
      fullscreenHeartRateVisible.style.fontSize = window.getComputedStyle(proto).fontSize;
    }

    function updateFullScreenHeartRate(bpm) {
      fullscreenHeartRateVisible.textContent = bpm;
      fullscreenHeartRateVisible.classList.remove('hr-blue','hr-green','hr-yellow','hr-orange','hr-red');
      // Color HR
      const zone = getZoneClass(bpm);
      if(zone) fullscreenHeartRateVisible.classList.add(zone);

      // Indicador flecha
      indicadorFlecha.classList.remove('arriba', 'abajo', 'ok');
      const arrowType = getIndicadorFlecha(bpm);
      if (arrowType === 'arriba') {
        indicadorFlecha.classList.add('arriba');
        indicadorFlecha.innerHTML = "&#8593;"; // Flecha arriba ↑
      } else if (arrowType === 'abajo') {
        indicadorFlecha.classList.add('abajo');
        indicadorFlecha.innerHTML = "&#8595;"; // Flecha abajo ↓
      } else {
        indicadorFlecha.classList.add('ok');
        indicadorFlecha.innerHTML = "";
      }

      if (!fullscreenContainer.classList.contains('hidden')) {
        fitHeartRateFontSize();
      }
    }

    window.addEventListener('resize', () => {
      if (!fullscreenContainer.classList.contains('hidden')) {
        fitHeartRateFontSize();
      }
    });

    // Manejo correcto de pantalla completa
    function enterFullScreen() {
      resultMsg.style.display = "none";
      fullscreenContainer.classList.remove('hidden');
      if (fullscreenContainer.requestFullscreen) {
        fullscreenContainer.requestFullscreen();
      } else if (fullscreenContainer.webkitRequestFullscreen) {
        fullscreenContainer.webkitRequestFullscreen();
      } else if (fullscreenContainer.msRequestFullscreen) {
        fullscreenContainer.msRequestFullscreen();
      }
      setTimeout(fitHeartRateFontSize, 200);
    }
    function exitFullScreen() {
      if (document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if (document.msExitFullscreen) document.msExitFullscreen();
      }
      fullscreenContainer.classList.add('hidden');
      if (sessionElapsed > 0) {
        resultMsg.style.display = "block";
        const tiempoTotal = formatDuration(sessionElapsed);
        const tiempoEnZona = formatDuration(secondsInZone * 1000);
        let adherencia = "Mejorable";
        const prop = secondsInZone / Math.max(1,Math.floor(sessionElapsed/1000));
        if (prop > 0.75) adherencia = "¡Excelente adherencia!";
        else if (prop > 0.5) adherencia = "Bien, puedes mejorar";
        resultMsg.innerHTML = `Duración: <b>${tiempoTotal}</b> &nbsp; | &nbsp; Tiempo en zona: <b>${tiempoEnZona}</b><br>${adherencia}`;
      }
    }
    fullscreenBtn.addEventListener('click', enterFullScreen);
    exitFullscreenBtn.addEventListener('click', exitFullScreen);

    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement &&
          !document.webkitFullscreenElement &&
          !document.msFullscreenElement) {
        fullscreenContainer.classList.add('hidden');
        if (sessionElapsed > 0) {
          resultMsg.style.display = "block";
          const tiempoTotal = formatDuration(sessionElapsed);
          const tiempoEnZona = formatDuration(secondsInZone * 1000);
          let adherencia = "Mejorable";
          const prop = secondsInZone / Math.max(1,Math.floor(sessionElapsed/1000));
          if (prop > 0.75) adherencia = "¡Excelente adherencia!";
          else if (prop > 0.5) adherencia = "Bien, puedes mejorar";
          resultMsg.innerHTML = `Duración: <b>${tiempoTotal}</b> &nbsp; | &nbsp; Tiempo en zona: <b>${tiempoEnZona}</b><br>${adherencia}`;
        }
      }
      else {
        resultMsg.style.display = "none";
        setTimeout(fitHeartRateFontSize, 100);
      }
    });

    // Inicializa valores por defecto
    updateFullScreenHeartRate('--');
    sessionTime.textContent = "00:00:00";
  </script>
</body>
</html>
