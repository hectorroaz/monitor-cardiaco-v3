<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor de Frecuencia Cardíaca BLE v4.1 (Mejorado)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --c-z1: #2563eb; --c-z2: #059669; --c-z3: #fbbf24; --c-z4: #fb923c;
      --c-bg: #0f172a; --c-card: #1e293b; --c-text: #f8fafc;
    }
    body { font-family: 'Inter', sans-serif; background: var(--c-bg); color: var(--c-text); }
    /* Estilos existentes... */
    
    /* Nuevos estilos mejorados */
    .gradient-border { border: double 2px transparent; background-image: linear-gradient(var(--c-bg), var(--c-bg)), 
                      linear-gradient(45deg, #6366f1, #ec4899, #f59e0b); background-origin: border-box; background-clip: padding-box, border-box; }
    
    .progress-ring { transition: stroke-dashoffset 0.3s; transform: rotate(-90deg); }
    
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .status-connecting { background: #f59e0b; animation: pulse 1.5s infinite; }
    .status-connected { background: #10b981; }
    .status-disconnected { background: #ef4444; }
    
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    
    .training-card { background: var(--c-card); border-radius: 1rem; padding: 1.2rem; margin-bottom: 1rem; }
    .training-card h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.8rem; color: #94a3b8; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; margin-bottom: 1.2rem; }
    .stat-box { background: rgba(30, 41, 59, 0.6); border-radius: 0.75rem; padding: 0.9rem; text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
    .stat-label { font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem; }
    
    .zone-progress { height: 8px; background: #334155; border-radius: 4px; margin: 0.5rem 0; overflow: hidden; }
    .zone-progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease-in-out; }
    
    .tutorial-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 100; }
    .tutorial-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--c-z1); 
                   display: flex; align-items: center; justify-content: center; color: white;
                   box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; }
    .tutorial-content { position: absolute; bottom: 60px; right: 0; width: 300px; background: var(--c-card);
                       padding: 1.2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
                       display: none; }
    .tutorial-content.show { display: block; animation: slideUp 0.3s ease-out; }
    
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    .connection-quality { display: flex; align-items: center; margin-top: 0.5rem; }
    .signal-bar { width: 4px; height: 12px; background: #475569; margin-right: 3px; border-radius: 1px; }
    .signal-bar.active { background: #10b981; }
    
    /* Mejoras responsive */
    @media (max-width: 640px) {
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-md bg-slate-900 gradient-border rounded-2xl shadow-xl p-6 space-y-6 text-center relative z-10">
    <header>
      <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">Monitor de Ritmo Cardíaco</h1>
      <div class="text-gray-400 mt-1 mb-4 text-sm flex items-center justify-center">
        <span>v 4.1</span>
        <span class="status-indicator status-disconnected ml-2" id="statusIndicator"></span>
      </div>
      <p class="text-gray-400 mt-2 mb-2">Conéctate a tu banda de frecuencia cardíaca BLE.</p>
      
      <div class="connection-quality justify-center" id="connectionQuality">
        <div class="signal-bar" id="signal1"></div>
        <div class="signal-bar" id="signal2"></div>
        <div class="signal-bar" id="signal3"></div>
        <div class="signal-bar" id="signal4"></div>
      </div>
    </header>
    
    <div class="border border-gray-700 rounded-lg p-6 bg-slate-800 relative">
      <div class="flex justify-center items-center mb-4">
        <svg id="heartIcon" class="w-16 h-16 text-red-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
        </svg>
      </div>
      <div class="relative inline-block">
        <div id="heartRateDisplay" class="text-7xl font-bold text-white tracking-tight" aria-live="polite">--</div>
        <div class="text-lg text-gray-400 absolute -bottom-6 left-1/2 transform -translate-x-1/2">BPM</div>
      </div>
      <p id="bluetoothStatus" class="mt-6 text-sm text-gray-400 h-5" role="status">Estado: Desconectado</p>
      
      <!-- Anillo de progreso de zona -->
      <svg class="w-32 h-32 absolute -right-4 -bottom-4 opacity-20" viewBox="0 0 36 36">
        <circle cx="18" cy="18" r="15.9155" class="stroke-slate-600" fill="none" stroke-width="2"/>
        <circle cx="18" cy="18" r="15.9155" class="progress-ring stroke-blue-500" fill="none" stroke-width="2" 
                stroke-dasharray="100, 100" id="zoneProgressRing"/>
      </svg>
    </div>
    
    <!-- Tarjeta de estadísticas -->
    <div class="training-card">
      <h3><i class="fas fa-chart-line mr-2"></i>ESTADÍSTICAS DE ENTRENAMIENTO</h3>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-value" id="avgHR">--</div>
          <div class="stat-label">Promedio</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="maxHR">--</div>
          <div class="stat-label">Máximo</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="timeInZone">--</div>
          <div class="stat-label">Tiempo en Zona</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="calories">--</div>
          <div class="stat-label">Calorías</div>
        </div>
      </div>
      
      <!-- Barra de progreso de zona -->
      <div class="flex items-center justify-between text-xs text-slate-400">
        <span>Zona Actual</span>
        <span id="zonePercentage">0%</span>
      </div>
      <div class="zone-progress">
        <div class="zone-progress-fill bg-blue-500" id="zoneProgressBar" style="width: 0%"></div>
      </div>
    </div>
    
    <div class="grid grid-cols-3 gap-4">
      <button id="fullscreenBtn" class="btn-main bg-white text-black hover:bg-gray-100 flex items-center justify-center">
        <i class="fas fa-expand mr-2"></i> Pantalla Completa
      </button>
      <button id="editZonesBtn" class="btn-main bg-gray-700 text-white hover:bg-gray-600 flex items-center justify-center">
        <i class="fas fa-sliders-h mr-2"></i> Zonas
      </button>
      <button id="disconnectBluetooth" class="btn-main bg-gray-800 text-white hover:bg-gray-700 disabled:bg-gray-600 flex items-center justify-center" disabled>
        <i class="fas fa-plug mr-2"></i> Desconectar
      </button>
    </div>
    <div>
      <button id="connectBluetooth" class="btn-main bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center">
        <i class="fas fa-bluetooth-b mr-2"></i> Conectar Sensor
      </button>
    </div>
    <div id="resultMsg" class="result-msg" style="display:none;"></div>
  </div>

  <!-- Botón de tutorial flotante -->
  <div class="tutorial-container">
    <div class="tutorial-btn" id="tutorialBtn">
      <i class="fas fa-question"></i>
    </div>
    <div class="tutorial-content" id="tutorialContent">
      <h3 class="font-bold mb-2">Cómo usar esta app</h3>
      <ul class="text-sm space-y-2">
        <li><i class="fas fa-bluetooth-b mr-2 text-blue-400"></i> Conecta tu sensor BLE de frecuencia cardíaca</li>
        <li><i class="fas fa-expand mr-2 text-purple-400"></i> Usa pantalla completa durante el entrenamiento</li>
        <li><i class="fas fa-tachometer-alt mr-2 text-green-400"></i> Define tus zonas personalizadas</li>
        <li><i class="fas fa-download mr-2 text-yellow-400"></i> Exporta tus datos al finalizar</li>
      </ul>
    </div>
  </div>

  <!-- El resto del código (fullscreenContainer, zoneEditorModal) se mantiene igual -->
  <div id="fullscreenContainer">
    <!-- ... contenido existente ... -->
  </div>

  <div id="zoneEditorModal" class="modal-overlay">
    <!-- ... contenido existente ... -->
  </div>

  <script>
    // --- Variables globales y constantes (mantener las existentes)
    let heartRateCharacteristic = null, bleDevice = null, wakeLock = null;
    let lastHR = null, zoneActual = 1;
    let sessionInterval = null, sessionStart = null, sessionElapsed = 0, sessionRunning = false, secondsInZone = 0;
    let hrHistory = [], maxHRInSession = 0, hrSum = 0, caloriesBurned = 0;
    let hrSamples = []; // {t: epoch_ms, hr: number}
    let connectionStability = 0; // Para medir la calidad de conexión
    let lastStableHRTime = 0;

    // Zonas (mantener las existentes)
    let ZONAS = [
      { id: 1, nombre: "Zona 1", rango: "94–113 bpm", min: 94, max: 113, label: "Z1", color: "#2563eb" },
      { id: 2, nombre: "Zona 2", rango: "113–132 bpm", min: 113, max: 132, label: "Z2", color: "#059669" },
      { id: 3, nombre: "Zona 3", rango: "132–150 bpm", min: 132, max: 150, label: "Z3", color: "#fbbf24" },
      { id: 4, nombre: "Zona 4", rango: "150–169 bpm", min: 150, max: 169, label: "Z4", color: "#fb923c" },
    ];
    const HR_ZONES_CLASSES = ['hr-blue', 'hr-green', 'hr-yellow', 'hr-orange', 'hr-red'];

    // SVGs para el toggle (mantener los existentes)
    const SVG_PLAY = '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><polygon points="10,8 16,12 10,16" fill="#fff"/></svg>';
    const SVG_PAUSE = '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><rect x="9" y="8" width="2" height="8" rx="1" fill="#fff"/><rect x="13" y="8" width="2" height="8" rx="1" fill="#fff"/></svg>';

    // --- Cacheo de Elementos del DOM (añadir los nuevos)
    const ui = {
      // Elementos existentes...
      connectBtn: document.getElementById('connectBluetooth'),
      disconnectBtn: document.getElementById('disconnectBluetooth'),
      statusElem: document.getElementById('bluetoothStatus'),
      hrDisplay: document.getElementById('heartRateDisplay'),
      heartIcon: document.getElementById('heartIcon'),
      fullscreenBtn: document.getElementById('fullscreenBtn'),
      fullscreenContainer: document.getElementById('fullscreenContainer'),
      exitFullscreenBtn: document.getElementById('exitFullscreenBtn'),
      resultMsg: document.getElementById('resultMsg'),
      sessionTime: document.getElementById('sessionTime'),
      toggleBtn: document.getElementById('sessionToggleBtn'),
      resetBtn: document.getElementById('resetSessionBtn'),
      exportCsvBtn: document.getElementById('exportCsvBtn'),
      hrProto: document.getElementById('fullscreenHeartRateProto'),
      hrVisible: document.getElementById('fullscreenHeartRateVisible'),
      arrow: document.getElementById('indicadorFlecha'),
      zoneBtnsRow: document.getElementById('zoneBtnsRow'),
      zoneDesc: document.getElementById('zoneDesc'),
      editZonesBtn: document.getElementById('editZonesBtn'),
      zoneEditorModal: document.getElementById('zoneEditorModal'),
      closeModalBtn: document.getElementById('closeModalBtn'),
      saveZonesBtn: document.getElementById('saveZonesBtn'),
      calculateZonesBtn: document.getElementById('calculateZonesBtn'),
      userAgeInput: document.getElementById('userAge'),
      zoneInputsContainer: document.getElementById('zoneInputsContainer'),
      addMinus10sBtn: document.getElementById('addMinus10sBtn'),
      add10sBtn: document.getElementById('add10sBtn'),
      add30sBtn: document.getElementById('add30sBtn'),
      add1mBtn: document.getElementById('add1mBtn'),
      snackbar: document.getElementById('snackbar'),
      hrTouchArea: document.getElementById('hrTouchArea'),
      
      // Nuevos elementos
      statusIndicator: document.getElementById('statusIndicator'),
      connectionQuality: document.getElementById('connectionQuality'),
      signal1: document.getElementById('signal1'),
      signal2: document.getElementById('signal2'),
      signal3: document.getElementById('signal3'),
      signal4: document.getElementById('signal4'),
      avgHR: document.getElementById('avgHR'),
      maxHR: document.getElementById('maxHR'),
      timeInZone: document.getElementById('timeInZone'),
      calories: document.getElementById('calories'),
      zoneProgressBar: document.getElementById('zoneProgressBar'),
      zonePercentage: document.getElementById('zonePercentage'),
      zoneProgressRing: document.getElementById('zoneProgressRing'),
      tutorialBtn: document.getElementById('tutorialBtn'),
      tutorialContent: document.getElementById('tutorialContent')
    };

    // ---- Nuevas funciones añadidas ----
    
    // Actualizar indicador de estado de conexión
    function updateConnectionStatus(status) {
      ui.statusIndicator.classList.remove('status-connecting', 'status-connected', 'status-disconnected');
      switch(status) {
        case 'connecting':
          ui.statusIndicator.classList.add('status-connecting');
          ui.statusElem.textContent = 'Conectando...';
          break;
        case 'connected':
          ui.statusIndicator.classList.add('status-connected');
          ui.statusElem.textContent = 'Conectado';
          break;
        default:
          ui.statusIndicator.classList.add('status-disconnected');
          ui.statusElem.textContent = 'Desconectado';
      }
    }
    
    // Medir calidad de señal basada en estabilidad de lecturas
    function updateConnectionQuality() {
      const now = Date.now();
      const timeDiff = now - lastStableHRTime;
      
      // Reiniciar si han pasado más de 10 segundos sin datos
      if (timeDiff > 10000) {
        connectionStability = Math.max(0, connectionStability - 5);
      }
      
      // Actualizar barras de señal
      const bars = [ui.signal1, ui.signal2, ui.signal3, ui.signal4];
      const activeBars = Math.min(4, Math.floor(connectionStability / 25));
      
      bars.forEach((bar, index) => {
        bar.classList.toggle('active', index < activeBars);
      });
    }
    
    // Calcular calorías (fórmula simplificada)
    function calculateCalories(avgHR, timeInMinutes, age, weight, isMale) {
      // Valores por defecto si no se proporcionan
      age = age || 30;
      weight = weight || 70;
      
      // Fórmula simplificada para estimar calorías
      const intensity = avgHR / (220 - age);
      const caloriesPerMinute = intensity * weight * 0.0175;
      return Math.round(caloriesPerMinute * timeInMinutes);
    }
    
    // Actualizar estadísticas de entrenamiento
    function updateTrainingStats() {
      if (hrHistory.length > 0) {
        const avg = Math.round(hrSum / hrHistory.length);
        ui.avgHR.textContent = avg;
        ui.maxHR.textContent = maxHRInSession;
        
        const totalSeconds = Math.floor(sessionElapsed / 1000);
        const zonePercentage = totalSeconds > 0 ? Math.round((secondsInZone / totalSeconds) * 100) : 0;
        ui.timeInZone.textContent = `${zonePercentage}%`;
        
        // Actualizar barra de progreso
        ui.zoneProgressBar.style.width = `${zonePercentage}%`;
        ui.zonePercentage.textContent = `${zonePercentage}%`;
        
        // Actualizar anillo de progreso
        const circumference = 2 * Math.PI * 15.9155;
        const dashoffset = circumference - (zonePercentage / 100) * circumference;
        ui.zoneProgressRing.style.strokeDashoffset = dashoffset;
        ui.zoneProgressRing.style.stroke = ZONAS.find(z => z.id === zoneActual)?.color || '#2563eb';
        
        // Calcular y mostrar calorías
        const timeInMinutes = totalSeconds / 60;
        const calories = calculateCalories(avg, timeInMinutes);
        caloriesBurned = calories;
        ui.calories.textContent = calories;
      }
    }
    
    // Mostrar/ocultar tutorial
    function toggleTutorial() {
      ui.tutorialContent.classList.toggle('show');
    }
    
    // Guardar datos de usuario localmente
    function saveUserData() {
      const userData = {
        age: parseInt(ui.userAgeInput.value) || 30,
        zones: ZONAS
      };
      localStorage.setItem('hrUserData', JSON.stringify(userData));
    }
    
    // Cargar datos de usuario guardados
    function loadUserData() {
      const savedData = localStorage.getItem('hrUserData');
      if (savedData) {
        const userData = JSON.parse(savedData);
        ui.userAgeInput.value = userData.age || '';
        if (userData.zones) {
          ZONAS = userData.zones;
        }
      }
    }
    
    // Inicializar la aplicación
    function initApp() {
      loadCustomZones();
      loadUserData();
      updateZoneVisuals();
      updateFullScreenHeartRate('--');
      ui.sessionTime.textContent = "00:00:00";
      
      // Configurar event listeners para nuevos elementos
      ui.tutorialBtn.addEventListener('click', toggleTutorial);
      document.addEventListener('click', (e) => {
        if (!ui.tutorialContent.contains(e.target) && e.target !== ui.tutorialBtn) {
          ui.tutorialContent.classList.remove('show');
        }
      });
      
      // Actualizar calidad de conexión periódicamente
      setInterval(updateConnectionQuality, 2000);
      
      // El resto de la inicialización...
    }

    // Modificar handleHeartRateNotification para actualizar estadísticas
    function handleHeartRateNotification(event) {
      const value = event.target.value;
      const flags = value.getUint8(0);
      const heartRate = (flags & 0x1) !== 0 ? value.getUint16(1, true) : value.getUint8(1);
      lastHR = heartRate;
      
      // Mejorar estabilidad de conexión
      if (heartRate > 0) {
        lastStableHRTime = Date.now();
        connectionStability = Math.min(100, connectionStability + 5);
      }
      
      ui.hrDisplay.textContent = heartRate;
      if (sessionRunning && heartRate > 0) {
        hrHistory.push(heartRate);
        hrSamples.push({ t: Date.now(), hr: heartRate });
        hrSum += heartRate;
        if (heartRate > maxHRInSession) { maxHRInSession = heartRate; }
        
        // Actualizar estadísticas
        updateTrainingStats();
      }
      
      // El resto de la función...
    }

    // Modificar connectToBluetooth para actualizar estado
    async function connectToBluetooth() {
      if (!navigator.bluetooth) {
        ui.statusElem.textContent = 'Error: Web Bluetooth no es compatible.';
        ui.statusElem.classList.add('text-red-600');
        return;
      }
      try {
        updateConnectionStatus('connecting');
        ui.connectBtn.disabled = true;
        bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: ['heart_rate'] }], optionalServices: ['device_information'] });
        await establishGattConnection(bleDevice);
      } catch (error) {
        ui.statusElem.textContent = `Error: ${error.message}`;
        ui.statusElem.classList.add('text-red-600');
        ui.connectBtn.disabled = false;
        updateConnectionStatus('disconnected');
      }
    }

    // Modificar establishGattConnection para actualizar estado
    async function establishGattConnection(device) {
      ui.statusElem.textContent = `Conectando a ${device.name || 'dispositivo'}...`;
      device.addEventListener('gattserverdisconnected', onDisconnected);
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService('heart_rate');
      heartRateCharacteristic = await service.getCharacteristic('heart_rate_measurement');
      await heartRateCharacteristic.startNotifications();
      heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateNotification);
      ui.statusElem.textContent = '¡Conectado! Escuchando latidos...';
      ui.statusElem.classList.add('text-green-600');
      ui.connectBtn.disabled = false;
      ui.disconnectBtn.disabled = false;
      reconnectAttempts = 0;
      updateConnectionStatus('connected');
      
      if ('wakeLock' in navigator) { try { navigator.wakeLock.request('screen').then(lock => wakeLock = lock); } catch(e){} }
    }

    // Modificar onDisconnected para actualizar estado
    function onDisconnected() {
      ui.statusElem.textContent = 'Dispositivo desconectado.';
      ui.statusElem.classList.remove('text-green-600');
      ui.statusElem.classList.add('text-red-600');
      ui.hrDisplay.textContent = '--';
      ui.disconnectBtn.disabled = true;
      updateConnectionStatus('disconnected');
      
      if (heartRateCharacteristic) {
        heartRateCharacteristic.removeEventListener('characteristicvaluechanged', handleHeartRateNotification);
        heartRateCharacteristic = null;
      }
      updateFullScreenHeartRate('--');
      lastHR = null;
      tryReconnect();
    }

    // Llamar a initApp en lugar del código de inicialización anterior
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
