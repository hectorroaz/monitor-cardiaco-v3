<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor de Frecuencia Cardíaca BLE v4.1 (Mejorado)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --c-z1: #2563eb; --c-z2: #059669; --c-z3: #fbbf24; --c-z4: #fb923c;
      --c-bg: #0f172a; --c-card: #1e293b; --c-text: #f8fafc;
    }
    body { font-family: 'Inter', sans-serif; background: var(--c-bg); color: var(--c-text); }
    
    /* Estilos existentes mejorados */
    button { transition: background-color 0.3s, transform 0.1s; }
    button:active { transform: scale(0.98); }
    .btn-main { width: 100%; padding: 0.85em 0; border-radius: 1em; font-weight: 600; margin-top: 1em; }
    .zone-btns-row { display: flex; flex-direction: row; gap: 0.5em; justify-content: center; align-items: center; margin-bottom: 0.8em; }
    .zone-btn { border-radius: 0.9em; padding: 0.35em 0.9em; font-size: 1.1rem; font-weight: 700; border: 2.5px solid #fff2; background: #23272f; color: #fff; transition: all 0.18s; cursor: pointer; outline: none; }
    .zone-btn.z1 { border-color: var(--c-z1); } .zone-btn.z2 { border-color: var(--c-z2); } .zone-btn.z3 { border-color: var(--c-z3); } .zone-btn.z4 { border-color: var(--c-z4); }
    .zone-btn.active.z1 { background: var(--c-z1); color: #fff; } .zone-btn.active.z2 { background: var(--c-z2); color: #fff; } .zone-btn.active.z3 { background: var(--c-z3); color: #1a1a1a; } .zone-btn.active.z4 { background: var(--c-z4); color: #fff; }
    .zone-desc { display: block; font-size: 1.05rem; text-align: center; margin-bottom: 0.8em; color: #e0e0e0; }
    @keyframes pulsate { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
    .heartbeat-animation { animation-name: pulsate; animation-duration: 1s; animation-iteration-count: infinite; animation-timing-function: ease-in-out; }
    .timer-box { font-family: 'Inter', monospace; font-size: 2.5rem; font-weight: 700; color: #06b6d4; margin-bottom: 0.8em; letter-spacing: 0.04em; }
    .controls-row { display: flex; flex-direction: row; gap: 1.2rem; justify-content: center; align-items: center; }
    .circle-btn { width: 3.1rem; height: 3.1rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; border: none; outline: none; cursor: pointer; position: relative; }
    .circle-btn svg { width: 1.8rem; height: 1.8rem; }
    .btn-play { background: #16a34a; } .btn-pause { background: #dc2626; } .btn-reset { background: #6b7280; }
    .btn-play:hover { background: #15803d; } .btn-pause:hover { background: #991b1b; } .btn-reset:hover { background: #334155; }
    .circle-btn.btn-reset.confirming { background: #dc2626 !important; }
    .circle-btn.btn-reset.confirming:hover { background: #991b1b !important; }

    .fullscreen-flex-vertical { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0; }
    .hr-container { width: 100vw; display: flex; justify-content: center; align-items: center; position: relative; }
    .controls-container { width: 100vw; display: flex; flex-direction: column; align-items: center; }
    .hr-size-proto { opacity: 0; position: absolute; left: 0; top: 0; pointer-events: none; user-select: none; z-index: -1; }
    #fullscreenHeartRateVisible { font-weight: 800; font-size: inherit; line-height: 1; text-align: center; word-break: break-all; white-space: nowrap; letter-spacing: -0.02em; margin: 0; padding: 0; overflow: hidden; display: block; z-index: 1; user-select: none; transition: color 0.2s; }
    .hr-blue { color: var(--c-z1) !important; } .hr-green { color: var(--c-z2) !important; } .hr-yellow { color: var(--c-z3) !important; } .hr-orange { color: var(--c-z4) !important; } .hr-red { color: #ef4444 !important; }
    .indicador-flecha { display: inline-flex; align-items: center; justify-content: center; margin-left: 2vw; font-size: 3rem; font-weight: 700; transition: all 0.18s; color: #f59e42; text-shadow: 0 2px 9px #0007; opacity: 1; min-width: 2.7rem; height: 2.7rem; user-select: none; }
    .indicador-flecha.arriba { color: #f87171; } .indicador-flecha.abajo { color: #60a5fa; } .indicador-flecha.ok { opacity: 0; transform: scale(0.5); }
    
    .gradient-border { border: double 2px transparent; background-image: linear-gradient(var(--c-bg), var(--c-bg)), 
                      linear-gradient(45deg, #6366f1, #ec4899, #f59e0b); background-origin: border-box; background-clip: padding-box, border-box; }
    
    .progress-ring { transition: stroke-dashoffset 0.3s; transform: rotate(-90deg); }
    
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .status-connecting { background: #f59e0b; animation: pulse 1.5s infinite; }
    .status-connected { background: #10b981; }
    .status-disconnected { background: #ef4444; }
    
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    
    .training-card { background: var(--c-card); border-radius: 1rem; padding: 1.2rem; margin-bottom: 1rem; }
    .training-card h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.8rem; color: #94a3b8; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; margin-bottom: 1.2rem; }
    .stat-box { background: rgba(30, 41, 59, 0.6); border-radius: 0.75rem; padding: 0.9rem; text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
    .stat-label { font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem; }
    
    .zone-progress { height: 8px; background: #334155; border-radius: 4px; margin: 0.5rem 0; overflow: hidden; }
    .zone-progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease-in-out; }
    
    .tutorial-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 100; }
    .tutorial-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--c-z1); 
                   display: flex; align-items: center; justify-content: center; color: white;
                   box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; }
    .tutorial-content { position: absolute; bottom: 60px; right: 0; width: 300px; background: var(--c-card);
                       padding: 1.2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
                       display: none; }
    .tutorial-content.show { display: block; animation: slideUp 0.3s ease-out; }
    
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    .connection-quality { display: flex; align-items: center; margin-top: 0.5rem; }
    .signal-bar { width: 4px; height: 12px; background: #475569; margin-right: 3px; border-radius: 1px; }
    .signal-bar.active { background: #10b981; }
    
    /* Mejoras responsive */
    @media (max-width: 640px) {
      .stats-grid { grid-template-columns: 1fr; }
    }
    
    @media (orientation: landscape) {
      .fullscreen-flex-vertical { flex-direction: row; align-items: stretch; gap: 0; }
      .controls-container { width: 45vw; max-width: 400px; min-width: 260px; height: 100vh; justify-content: center; align-items: center; padding-right: 1vw; padding-left: 1vw; }
      .hr-container { width: 55vw; min-width: 340px; height: 100vh; justify-content: flex-start; align-items: center; }
      .zone-btns-row { margin-bottom: 0.6em; }
      .zone-btn { padding: 0.3em 0.8em; font-size: 1rem; }
      .timer-box { font-size: 2.2rem; margin-bottom: 0.6em; }
      .controls-row { gap: 1rem; }
      .circle-btn { width: 2.8rem; height: 2.8rem; }
      .circle-btn svg { width: 1.6rem; height: 1.6rem; }
    }
    .result-msg { background: #18181b; color: #fafafa; border-radius: 1.2rem; padding: 1.1em 1.5em; font-size: 1.25rem; font-weight: 500; margin: 0.9em auto 0 auto; max-width: 95vw; box-shadow: 0 2px 16px #0006; border: 1.7px solid #444; text-align: center; }
    #fullscreenContainer { display: none !important; }
    #fullscreenContainer.active { display: flex !important; position: fixed; inset: 0; background: #000; z-index: 50; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: #1e1e1e; padding: 2rem; border-radius: 1.5rem; border: 1px solid #444; width: 90vw; max-width: 500px; }
    .modal-content h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; }
    .modal-input { background: #333; border: 1px solid #555; color: #fff; border-radius: 0.5em; padding: 0.5em 0.8em; width: 100%; }
    .modal-input:focus { outline: none; border-color: var(--c-z1); }

    /* v3.9: Snackbar (toast) */
    .snackbar { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); background: #111827; color: #e5e7eb; padding: 10px 14px; border-radius: 12px; border: 1px solid #374151; box-shadow: 0 6px 22px rgba(0,0,0,.35); font-weight: 600; opacity: 0; pointer-events: none; transition: opacity .2s; z-index: 80; }
    .snackbar.show { opacity: 1; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-md bg-slate-900 gradient-border rounded-2xl shadow-xl p-6 space-y-6 text-center relative z-10">
    <header>
      <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">Monitor de Ritmo Cardíaco</h1>
      <div class="text-gray-400 mt-1 mb-4 text-sm flex items-center justify-center">
        <span>v 4.1</span>
        <span class="status-indicator status-disconnected ml-2" id="statusIndicator"></span>
      </div>
      <p class="text-gray-400 mt-2 mb-2">Conéctate a tu banda de frecuencia cardíaca BLE.</p>
      
      <div class="connection-quality justify-center" id="connectionQuality">
        <div class="signal-bar" id="signal1"></div>
        <div class="signal-bar" id="signal2"></div>
        <div class="signal-bar" id="signal3"></div>
        <div class="signal-bar" id="signal4"></div>
      </div>
    </header>
    
    <div class="border border-gray-700 rounded-lg p-6 bg-slate-800 relative">
      <div class="flex justify-center items-center mb-4">
        <svg id="heartIcon" class="w-16 h-16 text-red-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
        </svg>
      </div>
      <div class="relative inline-block">
        <div id="heartRateDisplay" class="text-7xl font-bold text-white tracking-tight" aria-live="polite">--</div>
        <div class="text-lg text-gray-400 absolute -bottom-6 left-1/2 transform -translate-x-1/2">BPM</div>
      </div>
      <p id="bluetoothStatus" class="mt-6 text-sm text-gray-400 h-5" role="status">Estado: Desconectado</p>
      
      <!-- Anillo de progreso de zona -->
      <svg class="w-32 h-32 absolute -right-4 -bottom-4 opacity-20" viewBox="0 0 36 36">
        <circle cx="18" cy="18" r="15.9155" class="stroke-slate-600" fill="none" stroke-width="2"/>
        <circle cx="18" cy="18" r="15.9155" class="progress-ring stroke-blue-500" fill="none" stroke-width="2" 
                stroke-dasharray="100, 100" id="zoneProgressRing"/>
      </svg>
    </div>
    
    <!-- Tarjeta de estadísticas -->
    <div class="training-card">
      <h3><i class="fas fa-chart-line mr-2"></i>ESTADÍSTICAS DE ENTRENAMIENTO</h3>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-value" id="avgHR">--</div>
          <div class="stat-label">Promedio</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="maxHR">--</div>
          <div class="stat-label">Máximo</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="timeInZone">--</div>
          <div class="stat-label">Tiempo en Zona</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="calories">--</div>
          <div class="stat-label">Calorías</div>
        </div>
      </div>
      
      <!-- Barra de progreso de zona -->
      <div class="flex items-center justify-between text-xs text-slate-400">
        <span>Zona Actual</span>
        <span id="zonePercentage">0%</span>
      </div>
      <div class="zone-progress">
        <div class="zone-progress-fill bg-blue-500" id="zoneProgressBar" style="width: 0%"></div>
      </div>
    </div>
    
    <div class="grid grid-cols-3 gap-4">
      <button id="fullscreenBtn" class="btn-main bg-white text-black hover:bg-gray-100 flex items-center justify-center">
        <i class="fas fa-expand mr-2"></i> Pantalla Completa
      </button>
      <button id="editZonesBtn" class="btn-main bg-gray-700 text-white hover:bg-gray-600 flex items-center justify-center">
        <i class="fas fa-sliders-h mr-2"></i> Zonas
      </button>
      <button id="disconnectBluetooth" class="btn-main bg-gray-800 text-white hover:bg-gray-700 disabled:bg-gray-600 flex items-center justify-center" disabled>
        <i class="fas fa-plug mr-2"></i> Desconectar
      </button>
    </div>
    <div>
      <button id="connectBluetooth" class="btn-main bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center">
        <i class="fas fa-bluetooth-b mr-2"></i> Conectar Sensor
      </button>
    </div>
    <div id="resultMsg" class="result-msg" style="display:none;"></div>
  </div>

  <!-- Botón de tutorial flotante -->
  <div class="tutorial-container">
    <div class="tutorial-btn" id="tutorialBtn">
      <i class="fas fa-question"></i>
    </div>
    <div class="tutorial-content" id="tutorialContent">
      <h3 class="font-bold mb-2">Cómo usar esta app</h3>
      <ul class="text-sm space-y-2">
        <li><i class="fas fa-bluetooth-b mr-2 text-blue-400"></i> Conecta tu sensor BLE de frecuencia cardíaca</li>
        <li><i class="fas fa-expand mr-2 text-purple-400"></i> Usa pantalla completa durante el entrenamiento</li>
        <li><i class="fas fa-tachometer-alt mr-2 text-green-400"></i> Define tus zonas personalizadas</li>
        <li><i class="fas fa-download mr-2 text-yellow-400"></i> Exporta tus datos al finalizar</li>
      </ul>
    </div>
  </div>

  <!-- El resto del código (fullscreenContainer, zoneEditorModal) se mantiene igual -->
  <div id="fullscreenContainer">
    <div class="fullscreen-flex-vertical w-full h-full">
      <div class="controls-container">
        <div class="zone-btns-row" id="zoneBtnsRow"></div>
        <span id="zoneDesc" class="zone-desc"></span>
        <time id="sessionTime" class="timer-box">00:00:00</time>
        <!-- v3.9: Controles de ajuste de tiempo -->
        <div class="controls-row mb-3">
          <button class="circle-btn bg-gray-700 hover:bg-gray-600" id="addMinus10sBtn" title="Restar 10s" aria-label="Restar 10 segundos"><span class="font-bold">−10s</span></button>
          <button class="circle-btn bg-gray-700 hover:bg-gray-600" id="add10sBtn" title="Sumar 10s" aria-label="Sumar 10 segundos"><span class="font-bold">+10s</span></button>
          <button class="circle-btn bg-gray-700 hover:bg-gray-600" id="add30sBtn" title="Sumar 30s" aria-label="Sumar 30 segundos"><span class="font-bold">+30s</span></button>
          <button class="circle-btn bg-gray-700 hover:bg-gray-600" id="add1mBtn" title="Sumar 1 minuto" aria-label="Sumar un minuto"><span class="font-bold">+1m</span></button>
        </div>
        <div class="controls-row mt-2 mb-8">
          <!-- Toggle Play/Pause -->
          <button id="sessionToggleBtn" class="circle-btn btn-play" title="Iniciar" aria-label="Iniciar sesión" aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><polygon points="10,8 16,12 10,16" fill="#fff"/></svg>
          </button>
          <!-- Reset con confirmación -->
          <button id="resetSessionBtn" class="circle-btn btn-reset" title="Reiniciar" aria-label="Reiniciar Sesión">
            <svg viewBox="0 0 24 24" stroke="#fff" stroke-width="2" fill="none"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="6"/></svg>
          </button>
          <!-- v4.0: Exportar CSV -->
          <button id="exportCsvBtn" class="circle-btn bg-sky-700 hover:bg-sky-600" title="Exportar CSV" aria-label="Exportar datos de sesión a CSV">
            <svg viewBox="0 0 24 24" fill="#fff" aria-hidden="true"><path d="M5 20h14a1 1 0 0 0 1-1v-7h-2v6H6v-6H4v7a1 1 0 0 0 1 1zm7-3l5-5h-3V4h-4v8H7l5 5z"/></svg>
          </button>
        </div>
        <button id="exitFullscreenBtn" class="mt-2 bg-gray-800 text-white px-10 py-5 rounded-xl text-2xl hover:bg-gray-900">Salir</button>
      </div>
      <div class="hr-container" id="hrTouchArea">
        <span id="fullscreenHeartRateProto" class="hr-size-proto" aria-hidden="true">188</span>
        <span id="fullscreenHeartRateVisible">--</span>
        <span id="indicadorFlecha" class="indicador-flecha"></span>
      </div>
      <div id="snackbar" class="snackbar" role="status" aria-live="polite"></div>
    </div>
  </div>

  <div id="zoneEditorModal" class="modal-overlay">
    <div class="modal-content space-y-4">
      <h2>Editar Zonas de Frecuencia</h2>
      <div class="grid grid-cols-3 gap-4 items-center">
        <label for="userAge" class="text-right font-semibold">Tu Edad:</label>
        <input type="number" id="userAge" class="modal-input col-span-1" placeholder="Ej: 30" min="10" max="100" step="1">
        <button id="calculateZonesBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Calcular</button>
      </div>
      <div id="zoneInputsContainer" class="space-y-3 pt-4"></div>
      <div class="flex justify-end space-x-4 pt-4">
        <button id="closeModalBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Cerrar</button>
        <button id="saveZonesBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // --- Variables globales y constantes
    let heartRateCharacteristic = null, bleDevice = null, wakeLock = null;
    let lastHR = null, zoneActual = 1;
    let sessionInterval = null, sessionStart = null, sessionElapsed = 0, sessionRunning = false, secondsInZone = 0;
    let hrHistory = [], maxHRInSession = 0, hrSum = 0, caloriesBurned = 0;
    let hrSamples = []; // {t: epoch_ms, hr: number}
    let connectionStability = 0; // Para medir la calidad de conexión
    let lastStableHRTime = 0;

    let ZONAS = [
      { id: 1, nombre: "Zona 1", rango: "94–113 bpm", min: 94, max: 113, label: "Z1", color: "#2563eb" },
      { id: 2, nombre: "Zona 2", rango: "113–132 bpm", min: 113, max: 132, label: "Z2", color: "#059669" },
      { id: 3, nombre: "Zona 3", rango: "132–150 bpm", min: 132, max: 150, label: "Z3", color: "#fbbf24" },
      { id: 4, nombre: "Zona 4", rango: "150–169 bpm", min: 150, max: 169, label: "Z4", color: "#fb923c" },
    ];
    const HR_ZONES_CLASSES = ['hr-blue', 'hr-green', 'hr-yellow', 'hr-orange', 'hr-red'];

    // SVGs para el toggle
    const SVG_PLAY = '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><polygon points="10,8 16,12 10,16" fill="#fff"/></svg>';
    const SVG_PAUSE = '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><rect x="9" y="8" width="2" height="8" rx="1" fill="#fff"/><rect x="13" y="8" width="2" height="8" rx="1" fill="#fff"/></svg>';

    // --- Cacheo de Elementos del DOM
    const ui = {
      connectBtn: document.getElementById('connectBluetooth'),
      disconnectBtn: document.getElementById('disconnectBluetooth'),
      statusElem: document.getElementById('bluetoothStatus'),
      hrDisplay: document.getElementById('heartRateDisplay'),
      heartIcon: document.getElementById('heartIcon'),
      fullscreenBtn: document.getElementById('fullscreenBtn'),
      fullscreenContainer: document.getElementById('fullscreenContainer'),
      exitFullscreenBtn: document.getElementById('exitFullscreenBtn'),
      resultMsg: document.getElementById('resultMsg'),
      sessionTime: document.getElementById('sessionTime'),
      toggleBtn: document.getElementById('sessionToggleBtn'),
      resetBtn: document.getElementById('resetSessionBtn'),
      exportCsvBtn: document.getElementById('exportCsvBtn'),
      hrProto: document.getElementById('fullscreenHeartRateProto'),
      hrVisible: document.getElementById('fullscreenHeartRateVisible'),
      arrow: document.getElementById('indicadorFlecha'),
      zoneBtnsRow: document.getElementById('zoneBtnsRow'),
      zoneDesc: document.getElementById('zoneDesc'),
      editZonesBtn: document.getElementById('editZonesBtn'),
      zoneEditorModal: document.getElementById('zoneEditorModal'),
      closeModalBtn: document.getElementById('closeModalBtn'),
      saveZonesBtn: document.getElementById('saveZonesBtn'),
      calculateZonesBtn: document.getElementById('calculateZonesBtn'),
      userAgeInput: document.getElementById('userAge'),
      zoneInputsContainer: document.getElementById('zoneInputsContainer'),
      addMinus10sBtn: document.getElementById('addMinus10sBtn'),
      add10sBtn: document.getElementById('add10sBtn'),
      add30sBtn: document.getElementById('add30sBtn'),
      add1mBtn: document.getElementById('add1mBtn'),
      snackbar: document.getElementById('snackbar'),
      hrTouchArea: document.getElementById('hrTouchArea'),
      
      // Nuevos elementos
      statusIndicator: document.getElementById('statusIndicator'),
      connectionQuality: document.getElementById('connectionQuality'),
      signal1: document.getElementById('signal1'),
      signal2: document.getElementById('signal2'),
      signal3: document.getElementById('signal3'),
      signal4: document.getElementById('signal4'),
      avgHR: document.getElementById('avgHR'),
      maxHR: document.getElementById('maxHR'),
      timeInZone: document.getElementById('timeInZone'),
      calories: document.getElementById('calories'),
      zoneProgressBar: document.getElementById('zoneProgressBar'),
      zonePercentage: document.getElementById('zonePercentage'),
      zoneProgressRing: document.getElementById('zoneProgressRing'),
      tutorialBtn: document.getElementById('tutorialBtn'),
      tutorialContent: document.getElementById('tutorialContent')
    };

    // ---- Lógica de la aplicación ----

    function openZoneEditor() {
      let inputsHtml = '';
      ZONAS.forEach(z => {
        inputsHtml += `<div class=\"grid grid-cols-4 gap-2 items-center\">\n          <label class=\"text-right font-semibold pr-2\">${z.label}:</label>\n          <input type=\"number\" data-zone-id=\"${z.id}\" data-type=\"min\" class=\"modal-input\" value=\"${z.min}\">\n          <input type=\"number\" data-zone-id=\"${z.id}\" data-type=\"max\" class=\"modal-input\" value=\"${z.max}\">\n          <span class=\"text-xs text-gray-400 pl-1\">bpm</span>\n        </div>`;
      });
      ui.zoneInputsContainer.innerHTML = inputsHtml;
      ui.zoneEditorModal.classList.add('active');
    }

    function closeZoneEditor() { ui.zoneEditorModal.classList.remove('active'); }

    function saveZones() {
      const inputs = ui.zoneInputsContainer.querySelectorAll('input');
      inputs.forEach(input => {
        const zoneId = parseInt(input.dataset.zoneId, 10);
        const type = input.dataset.type;
        const value = parseInt(input.value, 10);
        const zone = ZONAS.find(z => z.id === zoneId);
        if(zone && !isNaN(value)) {
          zone[type] = value;
          zone.rango = `${zone.min}–${zone.max} bpm`;
        }
      });
      localStorage.setItem('customHeartRateZones', JSON.stringify(ZONAS));
      updateZoneVisuals();
      closeZoneEditor();
    }

    function loadCustomZones() {
      const savedZones = localStorage.getItem('customHeartRateZones');
      if (savedZones) { ZONAS = JSON.parse(savedZones); }
    }

    function calculateZonesByAge() {
      const age = parseInt(ui.userAgeInput.value, 10);
      if (isNaN(age) || age < 10 || age > 100) { alert("Por favor, introduce una edad válida."); return; }
      const mhr = 220 - age;
      const zonePercentages = [ {min: 0.5, max: 0.6}, {min: 0.6, max: 0.7}, {min: 0.7, max: 0.8}, {min: 0.8, max: 0.9} ];
      ui.zoneInputsContainer.querySelectorAll('input').forEach(input => {
        const zoneId = parseInt(input.dataset.zoneId, 10);
        const type = input.dataset.type;
        const percentage = zonePercentages[zoneId - 1][type];
        input.value = Math.round(mhr * percentage);
      });
    }

    function updateZoneDesc() {
      const z = ZONAS.find(x => x.id == zoneActual);
      if (z) ui.zoneDesc.innerHTML = `<b>${z.nombre}</b>: <span style=\"font-weight:700\">${z.rango}</span>`;
    }

    function updateZoneVisuals() {
      ui.zoneBtnsRow.innerHTML = '';
      ZONAS.forEach(z => {
        const btn = document.createElement("button");
        btn.className = `zone-btn z${z.id}`;
        btn.textContent = z.label;
        btn.title = `${z.nombre} (${z.rango})`;
        btn.dataset.zoneId = z.id;
        if (z.id === zoneActual) btn.classList.add("active");
        ui.zoneBtnsRow.appendChild(btn);
      });
      updateZoneDesc();
    }

    function formatDuration(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    // --- Hotfix 3.7.1: vibración robusta con fallback visual ---
    function tryVibrate(pattern) {
      if (!('vibrate' in navigator)) return;
      if (document.visibilityState !== 'visible') return;
      const didVibrate = navigator.vibrate(pattern);
      if (!didVibrate && ui.toggleBtn) {
        ui.toggleBtn.style.transform = 'scale(0.9)';
        setTimeout(() => { ui.toggleBtn.style.transform = ''; }, 120);
      }
    }

    function startSession() {
      if (!sessionRunning) {
        sessionRunning = true;
        sessionStart = Date.now() - sessionElapsed;
        sessionInterval = setInterval(updateSessionTime, 1000);
        reflectToggleUI();
        tryVibrate(30);
      }
    }

    function pauseSession() {
      if (sessionRunning) {
        sessionRunning = false;
        clearInterval(sessionInterval);
        sessionElapsed = Date.now() - sessionStart;
        reflectToggleUI();
        tryVibrate([25, 60, 25]);
      }
    }

    function toggleSession() { if (sessionRunning) { pauseSession(); } else { startSession(); } }

    function reflectToggleUI() {
      if (sessionRunning) {
        ui.toggleBtn.classList.remove('btn-play');
        ui.toggleBtn.classList.add('btn-pause');
        ui.toggleBtn.setAttribute('title', 'Pausar');
        ui.toggleBtn.setAttribute('aria-label', 'Pausar sesión');
        ui.toggleBtn.setAttribute('aria-pressed', 'true');
        ui.toggleBtn.innerHTML = SVG_PAUSE;
      } else {
        ui.toggleBtn.classList.remove('btn-pause');
        ui.toggleBtn.classList.add('btn-play');
        ui.toggleBtn.setAttribute('title', 'Iniciar');
        ui.toggleBtn.setAttribute('aria-label', 'Iniciar sesión');
        ui.toggleBtn.setAttribute('aria-pressed', 'false');
        ui.toggleBtn.innerHTML = SVG_PLAY;
      }
    }

    function resetSession() {
      pauseSession();
      sessionElapsed = 0;
      secondsInZone = 0;
      hrHistory = [];
      hrSamples = [];
      maxHRInSession = 0;
      hrSum = 0;
      updateSessionTime();
    }

    // v3.8: Reset con confirmación (doble toque en 3s)
    let resetConfirming = false;
    let resetConfirmTimeout = null;

    function onResetClick_v38() {
      if (!resetConfirming) {
        resetConfirming = true;
        ui.resetBtn.classList.add('confirming');
        ui.resetBtn.setAttribute('title', 'Toca de nuevo para REINICIAR (3s)');
        ui.resetBtn.setAttribute('aria-label', 'Confirmar reinicio (toca de nuevo)');
        clearTimeout(resetConfirmTimeout);
        resetConfirmTimeout = setTimeout(cancelResetConfirm_v38, 3000);
      } else {
        clearTimeout(resetConfirmTimeout);
        resetConfirming = false;
        ui.resetBtn.classList.remove('confirming');
        ui.resetBtn.setAttribute('title', 'Reiniciar');
        ui.resetBtn.setAttribute('aria-label', 'Reiniciar Sesión');
        resetSession();
      }
    }

    function cancelResetConfirm_v38() {
      resetConfirming = false;
      ui.resetBtn.classList.remove('confirming');
      ui.resetBtn.setAttribute('title', 'Reiniciar');
      ui.resetBtn.setAttribute('aria-label', 'Reiniciar Sesión');
    }

    function updateSessionTime() {
      const currentElapsed = sessionRunning ? Date.now() - sessionStart : sessionElapsed;
      ui.sessionTime.textContent = formatDuration(currentElapsed);
      if (sessionRunning && lastHR && isInZone(lastHR)) { secondsInZone++; }
    }

    // v3.9: Ajuste de tiempo (sumar/restar mientras corre o pausado)
    function adjustSessionTime(deltaMs) {
      if (sessionRunning) {
        sessionStart -= deltaMs;
      } else {
        sessionElapsed = Math.max(0, sessionElapsed + deltaMs);
      }
      updateSessionTime();
      showSnack((deltaMs >= 0 ? '+' : '−') + formatDuration(Math.abs(deltaMs)) + ' aplicado');
      tryVibrate(20);
    }

    // v3.9: Snackbar simple
    let snackTimer = null;
    function showSnack(text) {
      if (!ui.snackbar) return;
      ui.snackbar.textContent = text;
      ui.snackbar.classList.add('show');
      clearTimeout(snackTimer);
      snackTimer = setTimeout(() => ui.snackbar.classList.remove('show'), 1000);
    }

    // v3.9: Gestos táctiles (tap para toggle, swipe vertical para cambiar zona)
    let touchStartY = 0, touchStartX = 0, swiping = false;
    const SWIPE_THRESHOLD = 60;

    function onTouchStart(e) {
      const t = e.touches ? e.touches[0] : e;
      touchStartY = t.clientY;
      touchStartX = t.clientX;
      swiping = true;
    }
    function onTouchMove(e) { if (!swiping) return; }
    function onTouchEnd(e) {
      if (!swiping) return;
      swiping = false;
      const t = e.changedTouches ? e.changedTouches[0] : e;
      const dy = t.clientY - touchStartY;
      const dx = Math.abs(t.clientX - touchStartX);

      if (Math.abs(dy) > SWIPE_THRESHOLD && dx < 40) {
        if (dy < 0) { zoneActual = Math.min(ZONAS.length, zoneActual + 1); }
        else { zoneActual = Math.max(1, zoneActual - 1); }
        updateZoneVisuals();
        updateFullScreenHeartRate(lastHR ?? '--');
        showSnack('Zona: ' + (ZONAS.find(z=>z.id===zoneActual)?.label || zoneActual));
        tryVibrate(15);
      } else {
        toggleSession();
      }
    }

    // v4.0: Exportar CSV
    function exportCsv() {
      const header = 'elapsed_ms,time_iso,bpm\n';
      const base = (sessionStart && sessionRunning) ? sessionStart : (Date.now() - sessionElapsed);
      const rows = hrSamples.map(s => {
        const elapsed = s.t - base;
        return `${elapsed},${new Date(s.t).toISOString()},${s.hr}`;
      }).join('\n');
      const csv = header + rows;
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const filename = `hr_session_${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.style.display = 'none';
      document.body.appendChild(a); a.click();
      setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
      showSnack('CSV exportado');
    }

    // v4.0: Auto-reconexión BLE + desconexión manual
    let reconnectAttempts = 0;
    const MAX_RECONNECT = 5;

    async function connectToBluetooth() {
      if (!navigator.bluetooth) {
        ui.statusElem.textContent = 'Error: Web Bluetooth no es compatible.';
        ui.statusElem.classList.add('text-red-600');
        return;
      }
      try {
        updateConnectionStatus('connecting');
        ui.connectBtn.disabled = true;
        bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: ['heart_rate'] }], optionalServices: ['device_information'] });
        await establishGattConnection(bleDevice);
      } catch (error) {
        ui.statusElem.textContent = `Error: ${error.message}`;
        ui.statusElem.classList.add('text-red-600');
        ui.connectBtn.disabled = false;
        updateConnectionStatus('disconnected');
      }
    }

    async function establishGattConnection(device) {
      ui.statusElem.textContent = `Conectando a ${device.name || 'dispositivo'}...`;
      device.addEventListener('gattserverdisconnected', onDisconnected);
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService('heart_rate');
      heartRateCharacteristic = await service.getCharacteristic('heart_rate_measurement');
      await heartRateCharacteristic.startNotifications();
      heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateNotification);
      ui.statusElem.textContent = '¡Conectado! Escuchando latidos...';
      ui.statusElem.classList.add('text-green-600');
      ui.connectBtn.disabled = false;
      ui.disconnectBtn.disabled = false;
      reconnectAttempts = 0;
      updateConnectionStatus('connected');
      if ('wakeLock' in navigator) { try { navigator.wakeLock.request('screen').then(lock => wakeLock = lock); } catch(e){} }
    }

    function handleHeartRateNotification(event) {
      const value = event.target.value;
      const flags = value.getUint8(0);
      const heartRate = (flags & 0x1) !== 0 ? value.getUint16(1, true) : value.getUint8(1);
      lastHR = heartRate;
      
      // Mejorar estabilidad de conexión
      if (heartRate > 0) {
        lastStableHRTime = Date.now();
        connectionStability = Math.min(100, connectionStability + 5);
        updateConnectionQuality();
      }
      
      ui.hrDisplay.textContent = heartRate;
      if (sessionRunning && heartRate > 0) {
        hrHistory.push(heartRate);
        hrSamples.push({ t: Date.now(), hr: heartRate });
        hrSum += heartRate;
        if (heartRate > maxHRInSession) { maxHRInSession = heartRate; }
        
        // Actualizar estadísticas
        updateTrainingStats();
      }
      updateFullScreenHeartRate(heartRate);
      if (heartRate > 0) {
        const animationDuration = 60 / heartRate;
        ui.heartIcon.style.animationDuration = `${animationDuration.toFixed(2)}s`;
        ui.heartIcon.classList.add('heartbeat-animation');
      } else {
        ui.heartIcon.classList.remove('heartbeat-animation');
      }
    }

    async function tryReconnect() {
      if (!bleDevice || reconnectAttempts >= MAX_RECONNECT) return;
      const delay = Math.min(16000, 1000 * Math.pow(2, reconnectAttempts));
      reconnectAttempts++;
      ui.statusElem.textContent = `Reconectando (intento ${reconnectAttempts}/${MAX_RECONNECT})...`;
      await new Promise(r => setTimeout(r, delay));
      try {
        if (bleDevice.gatt.connected) return;
        await establishGattConnection(bleDevice);
        showSnack('Reconectado');
      } catch (e) {
        if (reconnectAttempts < MAX_RECONNECT) tryReconnect();
        else ui.statusElem.textContent = 'No se pudo reconectar.';
      }
    }

    function onDisconnected() {
      ui.statusElem.textContent = 'Dispositivo desconectado.';
      ui.statusElem.classList.remove('text-green-600');
      ui.statusElem.classList.add('text-red-600');
      ui.hrDisplay.textContent = '--';
      ui.disconnectBtn.disabled = true;
      updateConnectionStatus('disconnected');
      if (heartRateCharacteristic) {
        heartRateCharacteristic.removeEventListener('characteristicvaluechanged', handleHeartRateNotification);
        heartRateCharacteristic = null;
      }
      updateFullScreenHeartRate('--');
      lastHR = null;
      tryReconnect();
    }

    function manualDisconnect() {
      try { if (bleDevice?.gatt?.connected) bleDevice.gatt.disconnect(); } catch (e) {}
    }

    // v4.0: Re-adquirir Wake Lock al volver a la app
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && 'wakeLock' in navigator) {
        try { navigator.wakeLock.request('screen').then(lock => wakeLock = lock); } catch(e){}
      }
    });

    function isInZone(hr) { if (isNaN(hr)) return false; const z = ZONAS.find(x => x.id == zoneActual); return z && hr >= z.min && hr <= z.max; }

    function getIndicadorFlecha(hr) {
      if (isNaN(hr) || hr === '--') return 'ok';
      const z = ZONAS.find(x => x.id == zoneActual);
      if (!z) return 'ok';
      if (hr < z.min) return "arriba";
      if (hr > z.max) return "abajo";
      return "ok";
    }

    function getZoneClass(hr) {
      if (isNaN(hr) || hr === '--') return '';
      if (hr >= 170) return 'hr-red';
      const zone = ZONAS.find(z => hr >= z.min && hr <= z.max);
      if(zone) return `hr-${['blue','green','yellow','orange'][zone.id - 1]}`;
      return '';
    }

    function fitHeartRateFontSize() {
      if (!ui.hrProto) return;
      const media = window.matchMedia("(orientation: landscape)");
      const boxW = window.innerWidth * (media.matches ? 0.53 : 0.95);
      const boxH = window.innerHeight * (media.matches ? 0.93 : 0.33);
      ui.hrProto.textContent = '188';
      ui.hrProto.style.fontSize = '200px';
      const rect = ui.hrProto.getBoundingClientRect();
      const scale = Math.min(boxW / rect.width, boxH / rect.height, 1.17);
      ui.hrVisible.style.fontSize = (200 * scale) + 'px';
    }

    function updateFullScreenHeartRate(bpm) {
      ui.hrVisible.textContent = bpm;
      ui.hrVisible.classList.remove(...HR_ZONES_CLASSES);
      const zoneClass = getZoneClass(bpm);
      if (zoneClass) ui.hrVisible.classList.add(zoneClass);
      const arrowType = getIndicadorFlecha(bpm);
      ui.arrow.classList.remove('arriba', 'abajo', 'ok');
      ui.arrow.classList.add(arrowType);
      if (arrowType === 'arriba') { ui.arrow.innerHTML = "&#8593;"; }
      else if (arrowType === 'abajo') { ui.arrow.innerHTML = "&#8595;"; }
      else { ui.arrow.textContent = ""; }
      if (ui.fullscreenContainer.classList.contains('active')) { fitHeartRateFontSize(); }
    }

    function enterFullScreen() {
      ui.resultMsg.style.display = "none";
      ui.fullscreenContainer.classList.add('active');
      updateZoneVisuals();
      setTimeout(fitHeartRateFontSize, 50);
      if (ui.fullscreenContainer.requestFullscreen) ui.fullscreenContainer.requestFullscreen();
    }

    function handleExitFullscreen() {
      ui.fullscreenContainer.classList.remove('active');
      if (sessionElapsed > 0) {
        const avgHR = hrHistory.length > 0 ? Math.round(hrSum / hrHistory.length) : 0;
        const adherence = Math.round(secondsInZone / Math.max(1, Math.floor(sessionElapsed / 1000)) * 100);
        ui.resultMsg.innerHTML = `Duración: <b>${formatDuration(sessionElapsed)}</b> | En Zona: <b>${adherence}%</b><br>FC Prom: <b>${avgHR}</b> bpm | FC Max: <b>${maxHRInSession}</b> bpm`;
        ui.resultMsg.style.display = "block";
      }
    }

    function exitFullScreen() { if (document.fullscreenElement) document.exitFullscreen(); handleExitFullscreen(); }

    // ---- Nuevas funciones añadidas ----
    
    // Actualizar indicador de estado de conexión
    function updateConnectionStatus(status) {
      ui.statusIndicator.classList.remove('status-connecting', 'status-connected', 'status-disconnected');
      switch(status) {
        case 'connecting':
          ui.statusIndicator.classList.add('status-connecting');
          ui.statusElem.textContent = 'Conectando...';
          break;
        case 'connected':
          ui.statusIndicator.classList.add('status-connected');
          ui.statusElem.textContent = 'Conectado';
          break;
        default:
          ui.statusIndicator.classList.add('status-disconnected');
          ui.statusElem.textContent = 'Desconectado';
      }
    }
    
    // Medir calidad de señal basada en estabilidad de lecturas
    function updateConnectionQuality() {
      const now = Date.now();
      const timeDiff = now - lastStableHRTime;
      
      // Reiniciar si han pasado más de 10 segundos sin datos
      if (timeDiff > 10000) {
        connectionStability = Math.max(0, connectionStability - 5);
      }
      
      // Actualizar barras de señal
      const bars = [ui.signal1, ui.signal2, ui.signal3, ui.signal4];
      const activeBars = Math.min(4, Math.floor(connectionStability / 25));
      
      bars.forEach((bar, index) => {
        bar.classList.toggle('active', index < activeBars);
      });
    }
    
    // Calcular calorías (fórmula simplificada)
    function calculateCalories(avgHR, timeInMinutes, age, weight, isMale) {
      // Valores por defecto si no se proporcionan
      age = age || 30;
      weight = weight || 70;
      
      // Fórmula simplificada para estimar calorías
      const intensity = avgHR / (220 - age);
      const caloriesPerMinute = intensity * weight * 0.0175;
      return Math.round(caloriesPerMinute * timeInMinutes);
    }
    
    // Actualizar estadísticas de entrenamiento
    function updateTrainingStats() {
      if (hrHistory.length > 0) {
        const avg = Math.round(hrSum / hrHistory.length);
        ui.avgHR.textContent = avg;
        ui.maxHR.textContent = maxHRInSession;
        
        const totalSeconds = Math.floor(sessionElapsed / 1000);
        const zonePercentage = totalSeconds > 0 ? Math.round((secondsInZone / totalSeconds) * 100) : 0;
        ui.timeInZone.textContent = `${zonePercentage}%`;
        
        // Actualizar barra de progreso
        ui.zoneProgressBar.style.width = `${zonePercentage}%`;
        ui.zonePercentage.textContent = `${zonePercentage}%`;
        
        // Actualizar anillo de progreso
        const circumference = 2 * Math.PI * 15.9155;
        const dashoffset = circumference - (zonePercentage / 100) * circumference;
        ui.zoneProgressRing.style.strokeDashoffset = dashoffset;
        ui.zoneProgressRing.style.stroke = ZONAS.find(z => z.id === zoneActual)?.color || '#2563eb';
        
        // Calcular y mostrar calorías
        const timeInMinutes = totalSeconds / 60;
        const calories = calculateCalories(avg, timeInMinutes);
        caloriesBurned = calories;
        ui.calories.textContent = calories;
      }
    }
    
    // Mostrar/ocultar tutorial
    function toggleTutorial() {
      ui.tutorialContent.classList.toggle('show');
    }
    
    // Guardar datos de usuario localmente
    function saveUserData() {
      const userData = {
        age: parseInt(ui.userAgeInput.value) || 30,
        zones: ZONAS
      };
      localStorage.setItem('hrUserData', JSON.stringify(userData));
    }
    
    // Cargar datos de usuario guardados
    function loadUserData() {
      const savedData = localStorage.getItem('hrUserData');
      if (savedData) {
        const userData = JSON.parse(savedData);
        ui.userAgeInput.value = userData.age || '';
        if (userData.zones) {
          ZONAS = userData.zones;
        }
      }
    }

    // --- Inicialización y Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
      loadCustomZones();
      loadUserData();
      updateZoneVisuals();
      updateFullScreenHeartRate('--');
      ui.sessionTime.textContent = "00:00:00";

      // Event listeners originales
      ui.connectBtn.addEventListener('click', connectToBluetooth);
      ui.disconnectBtn.addEventListener('click', manualDisconnect);
      ui.exportCsvBtn.addEventListener('click', exportCsv);
      ui.toggleBtn.addEventListener('click', toggleSession);
      ui.resetBtn.addEventListener('click', onResetClick_v38);
      ui.fullscreenBtn.addEventListener('click', enterFullScreen);
      ui.exitFullscreenBtn.addEventListener('click', exitFullScreen);

      // v3.9: botones de ajuste de tiempo
      ui.addMinus10sBtn.addEventListener('click', () => adjustSessionTime(-10 * 1000));
      ui.add10sBtn.addEventListener('click', () => adjustSessionTime(10 * 1000));
      ui.add30sBtn.addEventListener('click', () => adjustSessionTime(30 * 1000));
      ui.add1mBtn.addEventListener('click', () => adjustSessionTime(60 * 1000));

      // Tecla SPACE para alternar play/pause (si hay teclado BT)
      document.addEventListener('keydown', (e) => { if (e.code === 'Space') { e.preventDefault(); toggleSession(); } });

      ui.editZonesBtn.addEventListener('click', openZoneEditor);
      ui.closeModalBtn.addEventListener('click', closeZoneEditor);
      ui.saveZonesBtn.addEventListener('click', saveZones);
      ui.calculateZonesBtn.addEventListener('click', calculateZonesByAge);

      ui.zoneBtnsRow.addEventListener('click', (event) => {
        const clickedBtn = event.target.closest('.zone-btn');
        if (!clickedBtn) return;
        zoneActual = parseInt(clickedBtn.dataset.zoneId, 10);
        updateZoneVisuals();
        updateFullScreenHeartRate(lastHR ?? '--');
      });

      window.addEventListener('resize', () => { if (ui.fullscreenContainer.classList.contains('active')) fitHeartRateFontSize(); });
      document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement && ui.fullscreenContainer.classList.contains('active')) { handleExitFullscreen(); } });

      // v3.9: Gestos táctiles sobre el área de HR
      ui.hrTouchArea.addEventListener('touchstart', onTouchStart, {passive: true});
      ui.hrTouchArea.addEventListener('touchmove', onTouchMove, {passive: true});
      ui.hrTouchArea.addEventListener('touchend', onTouchEnd);

      // Nuevos event listeners
      ui.tutorialBtn.addEventListener('click', toggleTutorial);
      document.addEventListener('click', (e) => {
        if (!ui.tutorialContent.contains(e.target) && e.target !== ui.tutorialBtn) {
          ui.tutorialContent.classList.remove('show');
        }
      });
      
      // Actualizar calidad de conexión periódicamente
      setInterval(updateConnectionQuality, 2000);

      // Intento de reconexión a dispositivos permitidos previamente (cuando el navegador lo soporte)
      if (navigator.bluetooth && navigator.bluetooth.getDevices) {
        try {
          const devices = await navigator.bluetooth.getDevices();
          const candidate = devices.find(d => d.gatt && !d.gatt.connected);
          if (candidate) {
            bleDevice = candidate;
            showSnack('Dispositivo recordado disponible');
          }
        } catch (e) { /* noop */ }
      }

      reflectToggleUI();
    });
  </script>
</body>
</html>
